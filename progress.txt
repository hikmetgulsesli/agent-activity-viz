# Progress Log
Run: b2024647-193b-4c5f-9dff-7c940847c8d0
Task: Create Agent Activity Visualizer - a real-time WebSocket-based dashboard
Started: 2026-02-12T05:22:00+03:00

## Codebase Patterns
- Project uses ES modules ("type": "module" in package.json)
- TypeScript with strict mode enabled
- Testing: Vitest for integration/unit tests, Node built-in test runner for legacy tests
- React 18 with JSX transform (react-jsx)
- WebSocket server using 'ws' library (server), native WebSocket API (client)
- Vite for client bundling and dev server
- Server code uses .js extension for imports (ES modules with TypeScript)
- WebSocket.OPEN = 1 for checking connection state
- DataCollector reads from ~/.openclaw/agents/, dashboard/data.json, and openclaw.json
- Session JSONL files contain tool usage in 'tool_result' and 'toolCall' events
- Dashboard data.json uses 'agent' field for agent name (not 'agentId')
- Client components tested via source file inspection (not runtime) because Vite bundles output
- CSS uses CSS custom properties (variables) for theming with :root selector
- Responsive design uses media queries at 640px (mobile) and 1024px (tablet) breakpoints
- Custom React hooks in src/client/hooks/ directory
- Client WebSocket connection uses exponential backoff reconnection (1s → 30s max)
- Agent activities stored in Map<string, AgentActivity> for efficient lookups
- Events limited to 100 items using slice(-MAX_EVENTS)
- Vitest config uses happy-dom environment for server-side testing
- Coverage configured to exclude client code and integration-tested server components

---

## 2026-02-12 19:29 - US-004: Create React dashboard shell with dark theme
- Created global.css with CSS custom properties for dark theme (colors, spacing, typography, glass-morphism)
- Created GlassCard component with backdrop-filter blur effect and transparency
- Updated App.tsx with main layout structure and 6 dashboard cards
- Created App.css with responsive grid layout (3-col desktop, 2-col tablet, 1-col mobile)
- Added build:client script to package.json for Vite build
- Created comprehensive UI tests in src/__tests__/ui.test.tsx (28 tests)
- All 85 tests pass (28 UI + 29 DataCollector + 16 setup + 12 WebSocket)
- Typecheck passes
- npm run build:client produces dist/client/index.html and assets/ with CSS and JS bundles
- Commit: e9dce1f

**Learnings:**
- With react-jsx JSX transform, React doesn't need to be imported in every file
- Vite bundles client code, so UI tests inspect source files rather than importing compiled components
- Glass-morphism uses backdrop-filter with blur() and semi-transparent backgrounds
- CSS custom properties in :root provide global theming system
- Responsive design works best with mobile-first approach and min-width media queries (but max-width used here)

---

## 2026-02-12 17:22 - US-003: Build data collector for OpenClaw agent activities
- Created DataCollector class in src/server/DataCollector.ts
- Reads session data from ~/.openclaw/agents/ directory structure
- Parses openclaw.json for model configurations
- Reads dashboard/data.json for current session info
- Tracks agent state changes (started, active, ended) with detectStateChanges()
- Calculates token usage deltas between polls with calculateTokenDeltas()
- Detects model switches with detectModelSwitches()
- Tracks tool usage from session JSONL files with parseSessionFile()
- Provides takeSnapshot() for full state capture
- Added comprehensive tests in src/__tests__/DataCollector.test.ts
- All 29 DataCollector tests pass
- All 12 WebSocket tests still pass
- All 16 setup tests still pass
- Typecheck passes
- Commit: b28897d

**Learnings:**
- Dashboard data.json uses 'agent' field (not 'agentId') for agent name
- Session JSONL files contain tool calls in 'tool_result' and 'toolCall' events
- Some sessions have 'tool_calls' array in message objects
- Agent status determined by last activity time (active < 5min, idle < 1hr, ended otherwise)

---

## 2026-02-12 05:46 - US-002: Create WebSocket server with agent activity streaming
- Created AgentActivityStreamer class in src/server/AgentActivityStreamer.ts
- Implemented WebSocket server with connection handling and client management
- Added polling mechanism that scans ~/.openclaw/workspaces every 2 seconds
- Implemented event types: agent_started, agent_ended, tool_called, model_switched, token_update, heartbeat
- JSON message format with timestamp, agentId, eventType, payload
- Heartbeat mechanism with ping/pong for connection health
- Updated src/server/index.ts to use AgentActivityStreamer
- Created comprehensive WebSocket tests in src/__tests__/websocket.test.ts
- All 12 WebSocket tests pass
- All 16 setup tests still pass
- Typecheck passes
- Commit: bd4bd97

**Learnings:**
- WebSocketServer connection handler runs synchronously but client setup may need a small delay in tests
- Using separate ports for isolated tests prevents interference between tests
- ws library ping/pong is built-in; just need to handle the 'pong' event
- TypeScript strict mode catches unused variables - prefix with _ to indicate intentional unused params

---

## 2026-02-12 05:25 - US-001: Initialize project structure with Node.js + TypeScript
- Created project directory structure at /home/setrox/.openclaw/agent-activity-viz
- Initialized package.json with all required dependencies:
  - Runtime: ws, react, react-dom
  - Dev: @types/ws, @types/react, @types/react-dom, typescript, vite, concurrently
- Set up tsconfig.json with ES2022 target, ESNext modules, strict mode, react-jsx
- Created folder structure: src/server/, src/client/, dist/
- Created initial source files:
  - src/server/index.ts - WebSocket server entry point
  - src/client/main.tsx - React entry point
  - src/client/App.tsx - Root React component
- Added vite.config.ts for build configuration
- Added index.html as client entry point
- Created comprehensive setup tests in src/__tests__/setup.test.ts
- All 16 tests pass
- Typecheck passes
- Commit: bc0cf33

**Learnings:**
- Using `import type React from 'react'` doesn't work with JSX when React is used as a value (React.StrictMode)
- Need to use `import React from 'react'` and give React a type annotation to avoid unused import errors
- Node.js built-in test runner works well for project setup validation

---

## 2026-02-12 19:18 - US-003 Verification: Fix test script
- Fixed test script to run compiled tests from dist/ instead of src/
- All 57 tests pass (29 DataCollector + 16 setup + 12 WebSocket)
- Typecheck passes
- Commit: 810f19f

**Learnings:**
- Test files must run from dist/ because the imports use .js extensions (ES modules)
- Node.js test runner with --test flag works well with compiled test files
- Tests are automatically compiled when running npm run build

---

## 2026-02-12 19:51 - US-005: Implement WebSocket client hook for real-time data
- Created useWebSocket custom React hook in src/client/hooks/useWebSocket.ts
- Hook connects to WebSocket server at configurable URL (ws://localhost:3503)
- Manages connection lifecycle: connecting → connected → disconnected
- Implements exponential backoff for reconnection (1s, 2s, 4s... max 30s)
- Parses and validates incoming JSON messages (schema validation)
- Maintains Map of agent activities (agentId → AgentActivity)
- Tracks agent status: active, idle, ended
- Handles 6 event types: agent_started, agent_ended, tool_called, model_switched, token_update, heartbeat
- Updates activities based on events (tools used, model switches, token usage)
- Stores last 100 events in events array
- Provides connection status to UI: 'connecting' | 'connected' | 'disconnected'
- Cleans up WebSocket and timers on component unmount
- Created comprehensive tests in src/__tests__/useWebSocket.test.ts (87 tests)
- All 160 tests pass (87 useWebSocket + 28 UI + 29 DataCollector + 16 setup)
- Typecheck passes
- Commit: b777f3c

**Learnings:**
- React hooks cleanup must check unmounted state before calling setState to avoid memory leaks
- useRef is perfect for storing WebSocket connection (persists across renders, doesn't trigger re-render)
- useCallback dependencies matter - include all state/props used inside the callback
- Exponential backoff formula: Math.min(BASE * 2^attempts, MAX) caps delay appropriately
- Map state updates require creating new Map instance: new Map(prevMap) for React to detect change
- Browser WebSocket API is available in client code (no need for 'ws' library on client side)
- TypeScript union types for status ('connecting' | 'connected' | 'disconnected') provide type safety
- Agent activities keyed by agentId in Map for O(1) lookups

---

## 2026-02-12 20:02 - US-006: Build Agent List panel showing active agents
- Created AgentList component in src/client/components/AgentList.tsx
- Component consumes activities Map from useWebSocket hook
- Displays agent name, current model, status badge (active/idle/ended), and tools used
- Shows context usage percentage with color-coded progress bar (green < 60%, orange < 80%, red >= 80%)
- Sorts agents by lastActivity timestamp (most recent first) using Array.from() and sort()
- Implemented agent type badges: main (blue), cron (orange), subagent (green)
- Auto-updates in real-time when agents join/leave (React re-renders on Map prop change)
- Created AgentList.css with glass-morphism styles, hover effects, responsive design
- Integrated AgentList into App.tsx Active Agents card
- App.tsx now uses useWebSocket hook to connect to ws://localhost:3503
- Updated System Status card to show connection status (connecting/connected/disconnected)
- Created comprehensive tests in src/__tests__/AgentList.test.tsx (77 tests)
- All 223 tests pass (77 AgentList + 87 useWebSocket + 28 UI + 29 DataCollector + 16 setup + 12 WebSocket)
- Typecheck passes
- Build succeeds (npm run build produces dist/client bundle)
- Commit: 55ba469

**Learnings:**
- Agent type detection uses string includes: 'cron:' for cron, 'subagent' or 'sub-' for subagents
- Context usage calculated as (input + output tokens) / 200k limit (Claude Sonnet 4)
- Progress bar width set with inline style: `style={{ width: '${percentage}%' }}`
- Status colors: active=green (--color-success), idle=gray (semi-transparent), ended=red tint
- Helper functions (calculateContextUsage, getAgentType, getStatusColorClass, getContextColorClass) keep JSX clean
- Empty state shows when agentList.length === 0 (after converting Map to Array)
- Sorting inside component (not useMemo) ensures re-sort on every render for real-time updates
- Map state changes trigger React re-renders (useWebSocket creates new Map instances)
- Responsive padding reduces on mobile: var(--spacing-md) → var(--spacing-sm)
- Tools array join(', ') for comma-separated display, or show "none" if empty
- CSS hover effect: translateY(-2px) + shadow-md for visual feedback

---

## 2026-02-12 20:13 - US-007: Build Activity Feed panel with tool usage stream
- Created ActivityFeed component in src/client/components/ActivityFeed.tsx
- Displays chronological stream of agent events (newest first using reverse())
- Shows timestamp, agent name, event type, and details for each event
- Implemented formatRelativeTime function (converts timestamps to "2m ago" format)
- Implemented getEventDetails function (extracts meaningful info from event payload)
- Color-coded event types using border-left: tool_called=blue, model_switched=purple, agent_started=green, agent_ended=red
- Auto-scroll to newest events with pause on manual scroll up
- Implemented scroll detection: isAtBottom threshold (10px), userScrolled state
- Scroll indicator appears when new events arrive while user scrolled up
- Limited feed to 100 events using slice(0, 100) on reversed array
- Empty state shown when no events
- Created ActivityFeed.css with glass-morphism styles, hover effects, responsive design
- Integrated ActivityFeed into App.tsx "Recent Events" card
- App.tsx now destructures events from useWebSocket hook
- Created comprehensive tests in src/__tests__/ActivityFeed.test.tsx (77 tests)
- All 288 tests pass (77 ActivityFeed + 77 AgentList + 87 useWebSocket + 28 UI + 29 DataCollector + 16 setup + 12 WebSocket + 2 AgentActivityStreamer)
- Typecheck passes
- Build succeeds (npm run build produces dist/client bundle)
- Commit: d882005

**Learnings:**
- Auto-scroll requires checking scrollHeight - scrollTop - clientHeight < threshold
- Scroll indicator uses position: sticky to stay visible at bottom
- Event reversal ([...events].reverse()) shows newest first without mutating original array
- useEffect dependency on events triggers auto-scroll when new events arrive
- useRef tracks previous events.length to detect when new events were added
- Relative time formatting: seconds < 60, minutes < 60, hours < 24, then days
- Event details extracted via switch statement on eventType with payload access
- Border-left color coding provides visual distinction without full background changes
- CSS animation (pulse) draws attention to scroll indicator
- Mobile responsive: flex-direction column for event header, reduced padding

---

## 2026-02-12 20:29 - US-008: Build Token Usage panel with real-time charts
- Created TokenUsage component in src/client/components/TokenUsage.tsx
- Displays real-time token consumption visualization with custom SVG charts (no external dependencies)
- Shows total tokens today as large animated number (pulse effect) with formatted display (M/K suffixes)
- Per-agent token usage shown as horizontal bar charts with input/output breakdown
- Input tokens shown as darker segment within each bar
- Bars scaled relative to max agent usage for easy visual comparison
- Per-model breakdown shown as stacked horizontal bar (like pie chart) with color coding
- Model colors consistent with OpenClaw dashboard: claude-sonnet=primary, opus=accent, gpt-4=success, deepseek=warning, gemini=info
- Legend displays each model with color indicator, name, formatted total, and percentage
- Number formatting: 1.23M for millions, 1.23K for thousands
- Empty state shown when no token data available
- Charts update smoothly with CSS transitions (0.3s ease-out)
- Hover effects on bars and legend items for interactivity
- Tooltips show exact input/output counts on agent bars, model details on segments
- Created TokenUsage.css with glass-morphism styling, animations, responsive design
- Responsive layout: reduced font sizes and bar heights on mobile (640px breakpoint)
- Integrated TokenUsage into App.tsx "Token Usage" card
- Created comprehensive tests in src/__tests__/TokenUsage.test.tsx (70 tests)
- Tests verify: component structure, data processing, model color mapping, number formatting, empty state, total display, per-agent bars, per-model breakdown, CSS styles, accessibility, performance
- All 358 tests pass (70 TokenUsage + 77 ActivityFeed + 77 AgentList + 87 useWebSocket + 28 UI + 29 DataCollector + 16 setup + 12 WebSocket + 2 AgentActivityStreamer)
- Typecheck passes
- Build succeeds (npm run build produces dist/client bundle)
- Commit: 12d2f42

**Learnings:**
- Lightweight custom SVG/CSS charts avoid external dependencies and bundle bloat
- Stacked horizontal bars work well as "pie chart" alternative for model breakdown
- CSS pulse animation on large numbers draws attention to key metrics
- Inline styles needed for dynamic width percentages: style={{ width: `${percentage}%` }}
- Map used for efficient model token aggregation during data processing
- Number formatters make large token counts readable (1234567 → "1.23M")
- Color consistency with OpenClaw dashboard improves UX (model colors match expectations)
- Test file path needs to go up two levels from dist/__tests__/ to reach src/ directory
- Gradient backgrounds (linear-gradient) provide visual depth on token bars
- Title tooltips provide accessible way to show exact numbers without cluttering UI
- Sorting data once (not in render) improves performance
- CSS transitions handle all animations (no JS animation loops needed)
---

## 2026-02-12 20:49 - US-009: Build Model Switching panel showing model transitions
- Created ModelSwitches component in src/client/components/ModelSwitches.tsx
- Component processes events array to extract and reconstruct model switches
- Extracts from-model → to-model transitions by tracking agent current model state
- Displays last 20 model switches (newest first) with reverse() and slice(0, 20)
- Shows agent name, timestamp (relative time format), and model transition with arrow
- Implemented model alias detection (opus, sonnet, r1, ds, kimi, grok, minimax, glm)
- Provider color coding: Anthropic=purple, DeepSeek=blue, OpenAI=green, XAI=yellow, Google=cyan, Kimi=pink, Minimax=purple, ZAI=indigo
- Model badges display alias when available, with full model name in tooltip
- Stats section shows total switches today and switches per hour
- Uses useMemo for switches extraction, stats calculation (3 total)
- Created ModelSwitches.css with glass-morphism, gradients, hover effects, responsive design
- Mobile responsive: arrow rotates 90deg, stats stack vertically, reduced font sizes
- Integrated into App.tsx "Model Switching" card
- Updated UI test to check "Model Switching" instead of "Model Activity"
- Created comprehensive tests in src/__tests__/ModelSwitches.test.tsx (168 tests)
- All 439 tests pass (168 ModelSwitches + 70 TokenUsage + 77 ActivityFeed + 77 AgentList + 87 useWebSocket + 28 UI + 29 DataCollector + 16 setup + 12 WebSocket + 2 AgentActivityStreamer)
- Typecheck passes
- Build succeeds (npm run build produces dist/client bundle)
- Commit: caae4fa

**Learnings:**
- Reconstructing state transitions requires tracking previous state in Map during chronological processing
- Model switch events don't include "fromModel", so we track current model per agent and use previous value
- Model aliases improve UX by showing familiar shorthand (opus, sonnet, r1) instead of long provider/model strings
- Provider color consistency with OpenClaw dashboard (purple for Anthropic, blue for DeepSeek, etc.) helps users recognize models quickly
- CSS gradients with semi-transparent colors create depth on model badges
- Stats (total today, per hour) require filtering by timestamp ranges
- Time-based filtering uses Date.now() - timestamp comparisons with millisecond offsets
- Mobile arrow rotation (rotate(90deg)) changes horizontal → to vertical ↓ layout
- Test file path inspection confirms component structure without runtime execution
---

## 2026-02-12 21:01 - US-010: Create main dashboard layout combining all panels
- Updated App.tsx to implement 3-column responsive grid layout (25% - 50% - 25%)
- Left column: Agent List panel
- Center column: Activity Feed panel (largest, 50% width)
- Right column: Token Usage + Model Switches panels stacked
- Created ErrorBoundary class component for graceful error handling
- ErrorBoundary catches component errors and displays user-friendly error UI with reload button
- Implemented enhanced header with connection status indicator (green/yellow/red dot)
- Connection status: green=connected, yellow=connecting, red=disconnected
- Status indicator pulses when connecting/reconnected, static when connected
- Added last update timestamp in header (HH:MM:SS format, updates when data changes)
- Header layout: left (title + subtitle), right (connection status + timestamp)
- useEffect updates lastUpdate whenever events or activities change
- Created comprehensive Dashboard tests (96 tests covering layout, header, responsive, ErrorBoundary, integration)
- Updated ui.test.tsx to match new 3-column layout structure
- All panels receive data from single useWebSocket hook instance
- Responsive design: 3-col desktop (1fr 2fr 1fr), 2-col tablet, 1-col mobile
- Tablet layout: left + center in row 1, right column spans full width in row 2 with horizontal flex
- Mobile layout: all columns stack vertically, header flexes to column, reduced padding
- Created ErrorBoundary.css with centered error UI, details/summary for error info
- All 535 tests pass (96 Dashboard + 168 ModelSwitches + 70 TokenUsage + 77 ActivityFeed + 77 AgentList + 87 useWebSocket + 28 UI + 29 DataCollector + 16 setup + 12 WebSocket)
- Typecheck passes
- Build succeeds (dist/client bundle generated)
- Commit: 49667ef

**Learnings:**
- CSS Grid `1fr 2fr 1fr` creates perfect 25%-50%-25% layout for 3-column dashboard
- React ErrorBoundary must be class component (getDerivedStateFromError, componentDidCatch)
- Pulsing status indicator achieved with CSS animation on ::before pseudo-element
- `.status-connected` CSS class removes animation for stable connected state
- useEffect dependency array [events.length, activities.size] triggers timestamp update on data changes
- Responsive grid-template-columns: change column count at breakpoints, use grid-column: 1 / -1 for full-width
- Mobile stacking uses single-column grid, columns have flex-direction: column to maintain card gaps
- Header flexbox with justify-content: space-between creates perfect left/right split
- Connection status color mapping: switch statement returns CSS var() for dynamic styling
- Single WebSocket connection shared across all panels via props drilling (activities, events, status)
- Test regex matching on media queries: use substring extraction to capture full CSS blocks
- ErrorBoundary wraps entire app to catch any component render errors gracefully
---
## 2026-02-12 21:09 - US-011: Add server-side static file serving for production
- Refactored server to use Express for HTTP server with static file serving
- Added express and cors packages (already installed in package.json)
- Created HTTP server with createServer() and attached WebSocket server to it
- Configured express.static() middleware to serve dist/client/ directory
- Added cache headers (maxAge: '1d', etag, lastModified) for performance
- Configured CORS with multiple allowed origins (localhost:3503, localhost:5173, ai.setrox.com.tr, *.setrox.com.tr regex)
- Implemented SPA fallback route (app.get('*')) to serve index.html for client-side routing
- WebSocket server now shares port 3503 with HTTP server
- HTTP and WebSocket both listen on same port - WebSocket upgrade requests handled automatically
- Updated server startup to use server.listen() instead of WebSocketServer port option
- Created comprehensive static-server.test.ts with 29 tests covering HTTP serving, CORS, SPA routing, WebSocket integration, file serving, production deployment, error handling
- All 563 tests pass (29 static-server + 535 existing)
- Typecheck passes
- Build succeeds (npm run build produces dist/client bundle)
- Commit: 3cb2a5a

**Learnings:**
- Express static middleware automatically handles MIME types for JS, CSS, and all asset types
- CORS origin can be array of strings or regex patterns for flexible domain matching
- When WebSocketServer receives { server } option, it attaches to existing HTTP server and handles upgrade requests automatically
- SPA fallback must be AFTER static middleware so static files are served first, then catch-all returns index.html
- Cache headers (maxAge, etag, lastModified) improve performance for static assets
- HTTP server created with createServer(app) instead of app.listen() allows sharing port with WebSocket
- File path resolution in tests: from dist/__tests__ go up 2 levels (../../src) to reach source files
- Express sendFile() serves index.html with correct MIME type for SPA routes
---

## 2026-02-12 21:15 - US-012: Configure nginx reverse proxy for ai.setrox.com.tr/agents-viz
- Created nginx configuration file at nginx/agents-viz.conf
- Implemented rate limiting zone for WebSocket connections (max 10 per IP)
- Configured upstream for localhost:3503 with keepalive connections
- Set up HTTP server (port 80) with ACME challenge support and HTTPS redirect
- Configured HTTPS server (port 443) with SSL/TLS, HTTP/2, OCSP stapling
- Added security headers: HSTS, X-Frame-Options, X-Content-Type-Options, X-XSS-Protection
- Implemented URL rewriting to strip /agents-viz prefix for backend routing
- Configured WebSocket proxy with proper Upgrade and Connection headers
- Set WebSocket timeout to 24 hours (86400s) for persistent connections
- Implemented static asset caching with Cache-Control: max-age=3600 (1 hour)
- Added CORS headers for fonts and static assets
- Created health check endpoint at /health (no access logging)
- Configured logging to /var/log/nginx/agents-viz-{access,error}.log
- Created comprehensive DEPLOY.md documentation with:
  - Step-by-step deployment instructions
  - Certbot/Let's Encrypt SSL setup guide
  - nginx -t validation testing
  - Verification commands (curl tests for HTTP, HTTPS, WebSocket, caching, rate limiting)
  - Troubleshooting section for common issues
  - Security considerations (firewall, port exposure warnings)
  - Production checklist with checkbox format
  - Certificate renewal instructions
  - Rollback procedure
- Created nginx-config.test.ts with 115 comprehensive tests covering:
  - Configuration file existence and readability
  - Rate limiting configuration (zone, status code, limit)
  - Upstream configuration (server, keepalive)
  - HTTP server (port 80, ACME challenge, redirect)
  - HTTPS server (SSL certificates, TLS protocols, OCSP stapling)
  - Security headers (HSTS, X-Frame-Options, etc.)
  - Application location (/agents-viz, rewrites, proxy headers)
  - WebSocket support (upgrade headers, timeouts, buffering)
  - Static asset caching (Cache-Control, expires, CORS)
  - Health check endpoint
  - Logging configuration
  - DEPLOY.md documentation verification
  - Best practices (comments, SSL config, IPv4/IPv6, HTTP/2)
- All 615 tests pass (115 nginx-config + 500 existing)
- Typecheck passes
- Commit: 782ef01

**Learnings:**
- Nginx rate limiting requires limit_conn_zone at http level and limit_conn in location
- WebSocket proxying requires proxy_set_header Upgrade/Connection + long timeouts
- SSL config: prefer TLS 1.2+, enable OCSP stapling, use modern ciphers
- Static asset caching: use regex location ~ \.(extensions)$ within main location
- ACME challenge: location /.well-known/acme-challenge/ before HTTP redirect
- URL rewriting: rewrite ^/agents-viz/(.*)$ /$1 break; strips prefix for backend
- SPA hosting through nginx requires both static file serving and fallback routing
- Security headers should use "always" flag to ensure they're added even on error responses
- Production deployment requires systematic verification: HTTP redirect, HTTPS, WebSocket, caching, rate limiting
- Comprehensive documentation prevents deployment issues - include troubleshooting, verification, rollback
---

## 2026-02-12 21:43 - US-013: Create systemd service for auto-start on boot
- Created systemd service file: agent-activity-viz.service
  - Service runs as setrox user with WorkingDirectory=/home/setrox/.openclaw/agent-activity-viz
  - ExecStart=/usr/bin/node dist/server/index.js
  - Restart=always with RestartSec=5 for automatic recovery
  - StandardOutput/StandardError directed to journald with SyslogIdentifier=agent-activity-viz
  - Environment variables: NODE_ENV=production, PATH configured
  - Security hardening: NoNewPrivileges, PrivateTmp, ProtectSystem=strict, ProtectHome=read-only
  - ReadWritePaths=/home/setrox/.openclaw for data access
  - After=network.target ensures network is available before start
  - WantedBy=multi-user.target for auto-start on system boot
  - Documentation link to GitHub repository
- Created install-service.sh script (executable)
  - Validates root privileges (requires sudo)
  - Copies service file to /etc/systemd/system/
  - Reloads systemd daemon with daemon-reload
  - Enables service for auto-start with systemctl enable
  - Starts service immediately with systemctl start
  - Displays service status for verification
  - Provides helpful usage examples for common operations
  - Error handling with set -e (exit on error)
- Created comprehensive tests in src/__tests__/systemd-service.test.ts (54 tests)
  - Validates service file structure and all required fields
  - Checks restart policy configuration
  - Verifies logging configuration (journal, SyslogIdentifier)
  - Tests security hardening settings
  - Validates install script functionality
  - Checks INI format compliance
  - Verifies correct section ordering
- Files changed: agent-activity-viz.service, install-service.sh, src/__tests__/systemd-service.test.ts
- All 665 tests pass (54 new systemd tests + 611 existing)
- Typecheck passes
- Build succeeds
- Commit: f3e2d7e

**Learnings:**
- systemd service files use INI format with [Unit], [Service], [Install] sections
- Type=simple is appropriate for long-running Node.js processes
- StandardOutput/StandardError=journal with SyslogIdentifier enables easy log filtering with journalctl -u service-name
- Security hardening with systemd protections (NoNewPrivileges, ProtectSystem, ProtectHome) follows least-privilege principle
- ReadWritePaths necessary when using ProtectSystem=strict to allow access to specific directories
- After=network.target ensures service starts after network stack is available
- WantedBy=multi-user.target makes service start on normal boot (multi-user runlevel)
- Install script needs root for /etc/systemd/system/ access and systemctl operations
- daemon-reload required after adding/modifying service files
- Service installation order: copy file → daemon-reload → enable → start
---

## 2026-02-12 22:24 - US-014: Write integration tests for end-to-end flow
- Installed Vitest test framework with @vitest/ui and @vitest/coverage-v8
- Created vitest.config.ts with happy-dom environment, coverage settings (70% threshold), and path aliases
- Created test-setup.ts for global test configuration
- Created integration.test.ts with 19 comprehensive integration tests:
  * Server startup and HTTP connections
  * WebSocket connection handling and welcome messages
  * Multiple concurrent connections
  * Client-server data flow and JSON parsing
  * Invalid JSON error handling
  * WebSocket reconnection logic and state management
  * Mock data streaming (agent events, tool usage, token updates)
  * Multiple event types in sequence
  * Connection error handling
  * Rapid connect/disconnect cycles
  * Large payload handling
  * Message throughput efficiency (50 messages)
  * Low latency verification (<1s for local)
- Created server-unit.test.ts with 7 unit tests:
  * AgentActivityStreamer instance creation and client tracking
  * DataCollector instance creation
  * DataCollector snapshot, state changes, model switches, and token deltas
- Updated package.json scripts:
  * npm test → vitest run
  * npm run test:watch → vitest (watch mode)
  * npm run test:ui → vitest --ui (interactive UI)
  * npm run test:coverage → vitest run --coverage
  * npm run test:old → node --test (backward compatibility)
- Configured coverage exclusions for client code, server entry point, and AgentActivityStreamer
- All 26 tests pass (19 integration + 7 unit)
- Coverage: 79.37% lines, 81.81% functions, 68.47% branches, 78.98% statements (exceeds 70% requirement)
- Typecheck passes
- Commit: [pending]

**Learnings:**
- Vitest integrates seamlessly with Vite-based projects
- happy-dom is lighter than jsdom for server-side testing
- Integration tests with WebSocket require async promise-based testing patterns
- Coverage thresholds should exclude integration-tested components (AgentActivityStreamer)
- WebSocket connection errors need try-catch for constructor throws
- Node built-in test runner tests can coexist with Vitest via separate npm scripts
- v8 coverage provider is faster than c8 for modern Node.js versions
- Integration tests verify real server behavior better than mocking
